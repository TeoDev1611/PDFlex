<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF_LEX_V2 // TERMINAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050505;          /* Negro Profundo */
            --surface: #121212;     /* Gris Oscuro */
            --border: #333333;      /* Bordes Sutiles */
            --primary: #2979ff;     /* Azul Eléctrico */
            --primary-dim: rgba(41, 121, 255, 0.15);
            --text: #e0e0e0;
            --text-muted: #888888;
            --mono: 'Fira Code', monospace; /* Fuente de Hacker */
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        /* NAVBAR TIPO CONSOLA */
        nav {
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            box-shadow: none;
        }
        .brand-logo {
            font-family: var(--mono);
            font-weight: 700;
            color: var(--primary) !important;
            letter-spacing: 1px;
            display: flex; align-items: center;
        }
        .brand-logo i { margin-right: 10px; color: #fff; }

        /* TARJETAS TECH */
        .card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card-title {
            font-family: var(--mono);
            color: var(--primary) !important;
            font-size: 1.1rem !important;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px !important;
            text-transform: uppercase;
        }

        /* PESTAÑAS (TABS) */
        .tabs { background-color: transparent; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tabs::-webkit-scrollbar { height: 0px; } /* Ocultar scrollbar */
        .tabs .tab a {
            color: var(--text-muted);
            font-family: var(--mono);
            font-weight: 600;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        .tabs .tab a:hover, .tabs .tab a.active {
            color: var(--primary);
            background-color: rgba(41, 121, 255, 0.05);
        }
        .tabs .indicator { background-color: var(--primary); height: 2px; box-shadow: 0 0 10px var(--primary); }

        /* AREA DE SUBIDA (DRAG & DROP) */
        .upload-area {
            background: #080808;
            border: 2px dashed var(--border);
            border-radius: 4px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: 20px;
        }
        .upload-area:hover, .upload-area.active {
            border-color: var(--primary);
            background: var(--primary-dim);
            box-shadow: inset 0 0 30px var(--primary-dim);
            cursor: pointer;
        }
        .upload-icon { font-size: 3rem; color: #444; transition: 0.3s; margin-bottom: 10px; }
        .upload-area:hover .upload-icon { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        
        .upload-text-main { font-family: var(--mono); font-size: 0.9rem; color: #fff; }
        .upload-text-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }

        /* INPUTS TECH (NUEVO) */
        .tech-input-group {
            display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end;
        }
        .tech-label {
            font-family: var(--mono); color: var(--primary); font-size: 0.8rem; display: block; margin-bottom: 5px;
        }
        .tech-input {
            background-color: #080808 !important;
            border: 1px solid var(--border) !important;
            color: #fff !important;
            font-family: var(--mono) !important;
            padding: 0 10px !important;
            height: 45px !important;
            box-sizing: border-box !important;
            border-radius: 2px !important;
        }
        .tech-input:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 5px var(--primary-dim) !important;
        }
        .tech-select {
            display: block !important; /* Materialize oculta selects por defecto */
            background-color: #080808;
            border: 1px solid var(--border);
            color: #fff;
            font-family: var(--mono);
            padding: 10px;
            height: 45px;
            width: 100%;
            border-radius: 2px;
        }
        .tech-select:focus { outline: none; border-color: var(--primary); }

        /* CHIPS DE ARCHIVOS (LISTA) */
        .file-list-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;
        }
        .chip-file {
            background: #000;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-family: var(--mono);
            padding: 5px 12px;
            font-size: 0.75rem;
            display: flex; align-items: center;
            box-shadow: 0 0 5px var(--primary-dim);
            animation: fadeIn 0.3s ease;
        }
        .chip-file i { font-size: 0.9rem; margin-right: 8px; color: #fff; }

        /* BOTONES MECÁNICOS */
        .btn-tech {
            background-color: var(--primary);
            border-radius: 2px;
            height: 48px; line-height: 48px;
            font-family: var(--mono);
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 4px 0 #0d47a1; /* Sombra sólida */
            width: 100%;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-tech:hover { background-color: #448aff; }
        .btn-tech:active { transform: translateY(4px); box-shadow: none; }
        .btn-tech i { font-size: 1.2rem; }

        /* MODAL DE ÉXITO */
        .modal {
            background-color: var(--surface);
            border: 1px solid var(--primary);
            box-shadow: 0 0 50px rgba(41, 121, 255, 0.15);
            max-width: 500px;
        }
        .modal-content { padding: 30px; text-align: center; }
        .modal-title {
            font-family: var(--mono);
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .modal-text { color: var(--text-muted); font-family: var(--mono); font-size: 0.9rem; }

        /* BARRA DE PROGRESO CYBERPUNK */
        .savings-wrapper {
            position: relative; height: 32px; background: #000;
            border: 1px solid var(--border); margin: 30px 0;
            overflow: hidden; display: none;
        }
        .savings-bar {
            height: 100%; width: 0%;
            background: repeating-linear-gradient(
                45deg, var(--primary), var(--primary) 10px,
                #1565c0 10px, #1565c0 20px
            );
            box-shadow: 0 0 15px var(--primary);
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }
        .savings-bar::after {
            content: ''; position: absolute; right: 0; top: 0; width: 2px; height: 100%;
            background: #fff; box-shadow: 0 0 10px #fff;
        }
        .savings-text {
            position: absolute; width: 100%; top: 0; left: 0; line-height: 30px;
            text-align: center; font-family: var(--mono); font-size: 0.8rem;
            color: #fff; text-shadow: 0 1px 3px #000; z-index: 5; letter-spacing: 1px;
        }

        /* LOADER */
        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-text { font-family: var(--mono); color: var(--primary); margin-top: 20px; animation: blink 1s infinite; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <nav>
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo">
                <i class="material-icons">terminal</i>PDF_LEX_V2
            </a>
        </div>
    </nav>

    <main class="container" style="margin-top: 40px;">
        <div class="row">
            <div class="col s12 m10 offset-m1">
                
                <div class="card" style="margin-bottom: 0; border-bottom: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
                    <div class="card-content" style="padding: 0;">
                        <ul class="tabs tabs-fixed-width">
                            <li class="tab"><a class="active" href="#unir">UNIR</a></li>
                            <li class="tab"><a href="#comprimir">COMPRIMIR</a></li>
                            <li class="tab"><a href="#img2pdf">IMG -> PDF</a></li>
                            <li class="tab"><a href="#extraer">EXTRAER</a></li>
                            <li class="tab"><a href="#rotar">ROTAR</a></li>
                        </ul>
                    </div>
                </div>

                <div id="unir" class="col s12" style="padding: 0;">
                    <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="card-content">
                            <span class="card-title">> SISTEMA_FUSION</span>
                            <form id="form-unir">
                                <div class="upload-area" id="drop-unir">
                                    <i class="material-icons upload-icon">call_merge</i>
                                    <div class="upload-text-main">ARRASTRA TUS PDFs AQUÍ</div>
                                    <div class="upload-text-sub">[ Múltiples archivos permitidos ]</div>
                                    <input type="file" id="input-unir" name="files" multiple accept=".pdf" style="display:none">
                                    <div id="list-unir" class="file-list-container"></div>
                                </div>
                                <button type="button" onclick="procesar('/api/unir', 'form-unir')" class="btn waves-effect waves-light btn-tech">
                                    <i class="material-icons left">play_arrow</i> EJECUTAR_UNION
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="comprimir" class="col s12" style="padding: 0;">
                    <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="card-content">
                            <span class="card-title">> MODULO_COMPRESION</span>
                            <form id="form-comprimir">
                                <div class="upload-area" id="drop-comprimir">
                                    <i class="material-icons upload-icon">compress</i>
                                    <div class="upload-text-main">SUBE ARCHIVOS PESADOS</div>
                                    <div class="upload-text-sub">[ Optimización inteligente activa ]</div>
                                    <input type="file" id="input-comprimir" name="files" multiple accept=".pdf" style="display:none">
                                    <div id="list-comprimir" class="file-list-container"></div>
                                </div>
                                <button type="button" onclick="procesar('/api/comprimir', 'form-comprimir', true)" class="btn waves-effect waves-light btn-tech">
                                    <i class="material-icons left">memory</i> INICIAR_COMPRESION
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="img2pdf" class="col s12" style="padding: 0;">
                    <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="card-content">
                            <span class="card-title">> CONVERTIDOR_IMG_BIN</span>
                            <form id="form-img2pdf">
                                <div class="upload-area" id="drop-img2pdf">
                                    <i class="material-icons upload-icon">photo_library</i>
                                    <div class="upload-text-main">SELECCIONA FOTOS (JPG/PNG)</div>
                                    <div class="upload-text-sub">[ Generando documento único ]</div>
                                    <input type="file" id="input-img2pdf" name="files" multiple accept="image/*" style="display:none">
                                    <div id="list-img2pdf" class="file-list-container"></div>
                                </div>
                                <button type="button" onclick="procesar('/api/img2pdf', 'form-img2pdf')" class="btn waves-effect waves-light btn-tech">
                                    <i class="material-icons left">picture_as_pdf</i> CONVERTIR_AHORA
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="extraer" class="col s12" style="padding: 0;">
                    <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="card-content">
                            <span class="card-title">> EXTRACTOR_RANGO</span>
                            <form id="form-extraer">
                                <div class="upload-area" id="drop-extraer">
                                    <i class="material-icons upload-icon">content_cut</i>
                                    <div class="upload-text-main">SUBE 1 PDF</div>
                                    <input type="file" id="input-extraer" name="file" accept=".pdf" style="display:none">
                                    <div id="list-extraer" class="file-list-container"></div>
                                </div>

                                <div class="tech-input-group row">
                                    <div class="col s6">
                                        <label class="tech-label">PÁGINA INICIO</label>
                                        <input type="number" name="inicio" class="tech-input" placeholder="Ej: 1" min="1" required>
                                    </div>
                                    <div class="col s6">
                                        <label class="tech-label">PÁGINA FIN</label>
                                        <input type="number" name="fin" class="tech-input" placeholder="Ej: 5" min="1" required>
                                    </div>
                                </div>

                                <button type="button" onclick="procesar('/api/extraer', 'form-extraer')" class="btn waves-effect waves-light btn-tech">
                                    <i class="material-icons left">content_cut</i> EXTRAER_PAGINAS
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="rotar" class="col s12" style="padding: 0;">
                    <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="card-content">
                            <span class="card-title">> MODULO_ROTACION</span>
                            <form id="form-rotar">
                                <div class="upload-area" id="drop-rotar">
                                    <i class="material-icons upload-icon">screen_rotation</i>
                                    <div class="upload-text-main">SUBE 1 PDF</div>
                                    <input type="file" id="input-rotar" name="file" accept=".pdf" style="display:none">
                                    <div id="list-rotar" class="file-list-container"></div>
                                </div>

                                <div class="row" style="margin-bottom: 20px;">
                                    <div class="col s12">
                                        <label class="tech-label">ÁNGULO DE ROTACIÓN (SENTIDO RELOJ)</label>
                                        <select name="grados" class="tech-select browser-default">
                                            <option value="90">90° GRADOS (DERECHA)</option>
                                            <option value="180">180° GRADOS (INVERTIR)</option>
                                            <option value="270">270° GRADOS (IZQUIERDA)</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="button" onclick="procesar('/api/rotar', 'form-rotar')" class="btn waves-effect waves-light btn-tech">
                                    <i class="material-icons left">rotate_right</i> APLICAR_ROTACION
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="loader">
        <div class="preloader-wrapper big active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left"><div class="circle"></div></div>
                <div class="gap-patch"><div class="circle"></div></div>
                <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
        </div>
        <div class="loader-text">> PROCESANDO_SOLICITUD...</div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-content">
            <i class="material-icons" style="font-size: 4rem; color: #00e676; margin-bottom: 10px;">check_circle</i>
            <div class="modal-title">PROCESO_FINALIZADO</div>
            <p class="modal-text">> Archivo generado y descargado correctamente.</p>
            
            <div id="savings-wrapper" class="savings-wrapper">
                <div id="savings-text" class="savings-text">CALCULANDO...</div>
                <div id="savings-bar" class="savings-bar"></div>
            </div>
            
            <a href="#!" class="modal-close btn-flat white-text" style="font-family: 'Fira Code'; border: 1px solid #333; margin-top: 15px;">
                [ CERRAR_VENTANA ]
            </a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            M.Tabs.init(document.querySelectorAll('.tabs'));
            M.Modal.init(document.querySelectorAll('.modal'));
            setupDragDrop();
        });

        // Configuración de Drag & Drop
        function setupDragDrop() {
            // IDs de las pestañas ACTUALIZADO CON LAS NUEVAS
            const areas = ['unir', 'comprimir', 'img2pdf', 'extraer', 'rotar']; 
            
            areas.forEach(id => {
                const area = document.getElementById('drop-' + id);
                const input = document.getElementById('input-' + id);
                const listContainer = document.getElementById('list-' + id);

                if(!area) return;

                // Clic para abrir
                area.onclick = (e) => {
                    if(e.target !== input) input.click();
                }

                // Cambio en input
                input.onchange = () => mostrarArchivos(input.files, listContainer, area);

                // Eventos Drag
                area.ondragover = (e) => { e.preventDefault(); area.classList.add('active'); };
                area.ondragleave = () => area.classList.remove('active');
                area.ondrop = (e) => {
                    e.preventDefault();
                    area.classList.remove('active');
                    input.files = e.dataTransfer.files;
                    mostrarArchivos(input.files, listContainer, area);
                };
            });
        }

        // Renderizar Chips "Tech"
        function mostrarArchivos(files, container, area) {
            container.innerHTML = ''; // Limpiar
            if (files.length > 0) {
                area.style.borderColor = '#2979ff';
                area.style.background = 'rgba(41, 121, 255, 0.05)';
                
                // Mostrar solo el primero si es Extraer/Rotar (opcional visualmente)
                Array.from(files).forEach(file => {
                    let chip = document.createElement('div');
                    chip.className = 'chip-file';
                    let icon = file.type.includes('image') ? 'image' : 'description';
                    let name = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                    chip.innerHTML = `<i class="material-icons">${icon}</i> ${name}`;
                    container.appendChild(chip);
                });
            }
        }

        // Lógica Principal de Envío
        async function procesar(url, formId, esCompresion = false) {
            const form = document.getElementById(formId);
            const input = form.querySelector('input[type="file"]');
            const listContainer = form.querySelector('.file-list-container');
            
            if (!input.files.length) {
                M.toast({html: '> ERROR: NO_DETECTO_ARCHIVOS', classes: 'red darken-4 rounded', displayLength: 2000});
                return;
            }

            // VALIDACIÓN ADICIONAL PARA EXTRAER
            if(formId === 'form-extraer') {
                const ini = form.querySelector('[name="inicio"]').value;
                const fin = form.querySelector('[name="fin"]').value;
                if(!ini || !fin) {
                    M.toast({html: '> ERROR: DEFINE RANGO DE PAGINAS', classes: 'red darken-4'});
                    return;
                }
            }

            // Mostrar Loader
            document.getElementById('loader').style.display = 'flex';
            const formData = new FormData(form);

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                
                // Si hay error en el backend (ej: rango inválido)
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || "Error del servidor");
                }

                // Obtener datos
                const blob = await response.blob();
                const headers = response.headers;
                
                // Descargar
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                
                // Nombre archivo
                let filename = "PDFlex_Resultado.pdf";
                const headerFilename = headers.get('content-disposition');
                if (headerFilename && headerFilename.includes('filename=')) {
                    filename = headerFilename.split('filename=')[1].replace(/"/g, '');
                } else if (esCompresion && input.files.length > 1) {
                    filename = "PDFlex_Pack.zip";
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();

                // OCULTAR LOADER Y ABRIR MODAL
                document.getElementById('loader').style.display = 'none';
                
                // Lógica Barra de Progreso (Solo compresión)
                const savingsWrapper = document.getElementById('savings-wrapper');
                const savingsBar = document.getElementById('savings-bar');
                const savingsText = document.getElementById('savings-text');
                const savingsPercent = headers.get('X-Savings-Percent');

                if (esCompresion && savingsPercent) {
                    savingsWrapper.style.display = 'block';
                    savingsBar.style.width = '0%';
                    savingsText.innerText = "CALCULANDO_DATOS...";
                    
                    setTimeout(() => {
                        savingsBar.style.width = savingsPercent + '%';
                        savingsText.innerText = `NIVEL_COMPRESION: ${savingsPercent}% OPTIMIZADO`;
                    }, 200);
                } else {
                    savingsWrapper.style.display = 'none';
                }

                // Abrir Modal
                const instance = M.Modal.getInstance(document.getElementById('modal-success'));
                instance.open();

                // Resetear Formulario
                form.reset(); // Limpia inputs texto también
                input.value = ""; 
                listContainer.innerHTML = "";
                const area = form.querySelector('.upload-area');
                area.style.borderColor = "#333"; 
                area.style.background = "#080808";

            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                M.toast({html: `> ERROR: ${error.message}`, classes: 'red darken-4'});
                console.error(error);
            }
        }
    </script>
</body>
</html>